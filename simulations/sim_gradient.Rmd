---
title: "Gradient Simulation"
params:
  out_dir: "."
  method: "transport"
  id: 1
  K: 5
  V: 200
  N: 50
  n_models: 10
  save_alphas: [0, 1]
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(alto)
library(dplyr)
library(stringr)
source("simulation_functions.R")
set.seed(params$id)
my_theme()
```

```{r}
K <- params$K
V <- params$V
N <- params$N
n_models <- params$n_models
lambdas <- list(beta = 0.5, gamma = 0.5, nu = 0.5, count = 1e4)
```

```{r}
stability <- list()
refinement <- list()
key_topics <- list()
alphas <- seq(0, 1, length.out = 20)
for (i in seq_along(alphas)) {
  sim_data <- simulate_gradient(N, K, V, lambdas, alpha = alphas[i])
  alignment <- fit_wrapper(sim_data$x, n_models, params$method)
  stability[[i]] <- alto:::compute_stability_along_branches(alignment@weights)
  refinement[[i]] <- alto:::compute_refinement_scores(alignment@weights)
  key_topics[[i]] <- alto:::compute_number_of_key_topics(alignment@weights)

  if (alphas[i] %in% params$save_alphas) {
    save(alignment, file = sprintf("alignment_%s_%s.rda", params$id, alphas[i]))
  }
}

bind_and_write(stability, str_c("stability-", params$id, ".csv"), params$id)
bind_and_write(refinement, str_c("refinement-", params$id, ".csv"), params$id)
bind_and_write(key_topics, str_c("key_topics-", params$id, ".csv"), params$id)
```
