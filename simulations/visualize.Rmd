---
title: "Visualize Results"
output: html_notebook
params:
    results_dir: "results/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 2)
```

```{r}
library(alto)
library(dplyr)
library(ggplot2)
library(readr)
library(tibble)
library(purrr)
library(stringr)
library(tidyr)
source("https://raw.githubusercontent.com/krisrs1128/topic_align/main/simulations/simulation_functions.R")
my_theme()
```

### True LDA Experiment

The simulation results we're working with are saved here:
https://uwmadison.box.com/shared/static/accan0ji43d7l97bia2fa9ai5zu826xm.gz

First, we plot a random flow.

```{r, fig.height = "5in", fig.width = "3in"}
lda_dir <- file.path(params$results_dir, "lda")
fits <- list(
  get(load(file.path(lda_dir, "exper-product_2_250_1000_5.rda")))[4],
  get(load(file.path(lda_dir, "exper-transport_2_250_1000_5.rda")))[4]
)
plot(fits[[1]][[1]]) +
  labs(x = "K Topics") +
  theme(axis.text.y = element_blank())
ggsave("~/Downloads/product-true-lda.png", dpi=500, height = unit(3, "in"), width = unit(5, "in"))
plot(fits[[2]][[1]]) +
  labs(x = "K Topics") +
  theme(axis.text.y = element_blank())
ggsave("~/Downloads/transport-true-lda.png", dpi=500, height = unit(3, "in"), width = unit(5, "in"))
```

```{r, fig.height = "4in", fig.width = "6in"}
plot_beta(fits[[1]][[1]], models = 2:10, n_features=25) +
  scale_size(range = c(0, 7))
ggsave("~/Downloads/product-true-lda-betas.png", dpi = 500)
plot_beta(fits[[2]][[1]], models = 2:10, n_features=25) +
  scale_size(range = c(0, 7))
ggsave("~/Downloads/transport-true-lda-betas.png", dpi = 500)
```


Now, we plot the stability curves.

```{r}
read_and_process <- function(pattern, grouping, directory, max_K=10) {
  paths <- list.files(directory, pattern, full = TRUE)
  map_dfr(paths, read_csv, .id = "file") %>%
    suppressMessages() %>%
    mutate(
      m = factor(m, levels = str_c("K", 1:max_K)),
      file = basename(paths[as.integer(file)]),
      method = ifelse(grepl("product", file), "product", "transport")
    ) %>%
    unite("group", grouping, remove = FALSE)
}
```

```{r}
read_betas <- function(paths) {
  betas <- list()
  beta_hats <- list()
  for (i in seq_along(paths)) {
    exper <- get(load(paths[i]))
    beta_hats[[i]] <- map_dfr(model(exper[[2]]), ~ .$beta, .id = "m") %>%
      mutate(sim = i)
    betas[[i]] <- map_dfr(exper[[1]]$beta, ~ .$beta, .id = "m") %>%
      mutate(sim = i)
  }
  
  list(
    beta_hats = bind_rows(beta_hats),
    betas = bind_rows(betas)
  )
}


estimate_similarities <- function(betas, beta_hats) {
  # for each simulation replicate
  # for each estimated beta_hat among the fitted models
  max_sim <- apply(betas[[i]] %*% t(beta_hats[[i]]), 1, max)
}
```

```{r}
paths <- list.files(lda_dir, "exper*", full = TRUE)
max_K <- 10
measures <- map_dfr(
  paths,
  ~ topics(get(load(.))[[4]]),
  .id = "file"
) %>%
  mutate(
    m = factor(m, levels = str_c("K", 1:max_K)),
    file = basename(paths[as.integer(file)]),
    method = ifelse(grepl("product", file), "product", "transport")
  )
```


```{r}
key_topics <- read_and_process("key*", c("id"), file.path(params$results_dir, "lda"))
```

```{r, fig.width = "5in", fig.height = "3in"}
key_counts <- key_topics %>%
  group_by(m, method) %>%
  count(n_key_topics) %>%
  filter(m != "K10")

ggplot(key_counts) +
  geom_hline(yintercept = 5) +
  geom_point(aes(x = m, y = n_key_topics, size = n)) +
  labs(x = "K Topics", y = "Key Topics") +
  facet_wrap(~ method)
ggsave("~/Downloads/key_topics-lda.png", dpi=500)
```

```{r}
ggplot(measures %>% filter(!(m %in% c("K1", "K10")))) +
  geom_violin(
    aes(m, refinement),
    fill = "black",
    bw = 0.05, size = 0
  ) +
  scale_y_log10() +
  labs(x = "K Topics", y = "refinement") +
  facet_grid(. ~ method)
ggsave("~/Downloads/refinement_lda.png", dpi=500)
```

#### Gradient Experiment

```{r}
gradient_dir <- file.path(params$results_dir, "gradient")
paths <- list.files(gradient_dir, "exper*", full = TRUE)
max_K <- 10
measures <- map_dfr(
  paths,
  ~ topics(get(load(.))[[2]]),
  .id = "file"
) %>%
  mutate(
    m = factor(m, levels = str_c("K", 1:max_K)),
    file = basename(paths[as.integer(file)]),
    method = ifelse(grepl("product", file), "product", "transport")
  ) %>%
  separate(file, c("prefix", "alpha", "rep", "N", "D", "K"),  "_", remove = FALSE) %>%
  mutate(alpha = as.numeric(alpha))
  

weights <- map_dfr(
  paths,
  ~ weights(get(load(.))[[2]]),
  .id = "file"
) %>%
  mutate(
    m = factor(m, levels = str_c("K", 1:max_K)),
    file = basename(paths[as.integer(file)]),
    method = ifelse(grepl("product", file), "product", "transport")
  )
```

```{r}
weights_ <- weights %>%
  mutate(
    m_ix = as.integer(m),
    m_next_ix = as.integer(m_next),
  ) %>%
  filter(m_next_ix == m_ix + 1) %>%
  left_join(
    measures %>% select(file, alpha, m, k, robustness),
    by = c("file", "m", "k")
  ) %>%
  left_join(
    measures %>% select(file, m, k, robustness) %>% rename(robustness_next = robustness),
    by = c("file" = "file", "k_next" = "k", "m_next" = "m")
  )
```

```{r}
subset_alpha <-  c(0, 0.2, 0.4, 0.6, 0.8, 1)
ggplot(
  weights_ %>% filter(alpha %in% subset_alpha),
  aes(m_ix, robustness, color = alpha)
  ) +
  geom_point(
    size = 0.05, alpha = 0.1 ,
    position = position_jitter(w = 0.15)
    ) +
  geom_point(
    data = weights_ %>% filter(alpha%in% subset_alpha, m_next_ix == 10),
    aes(m_next_ix, robustness_next),
    position = position_jitter(w = 0.15),
    size = 0.05, alpha = 0.1
  ) +
  scale_x_continuous(breaks = 1:10) +
  scico::scale_color_scico(palette = "vikO", breaks = c(0, 0.5, 1)) +
  scale_y_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  labs(col = expression(alpha), x = "K Topics") +
  guides(size = guide_legend(override.aes = list(alpha = 1))) +
  facet_grid(method ~ alpha, scale = "free_y") +
  theme(
    axis.text.x = element_text(size = 6),
    panel.grid.major.x = element_blank()
  )
ggsave("~/Downloads/gradient_stability.png", dpi = 1000, width = unit(8.5, "in"), height = unit(4, "in"))
```


```{r}
key_topics <- read_and_process("key*", c("file"), gradient_dir) %>%
  separate(file, c("tmp", "method", "alpha", "id", "N", "V", "K"), "_", remove = FALSE) %>%
  mutate(across(alpha:V, as.numeric))
```

```{r, fig.width = 5, fig.height = 3}
key_counts <- key_topics %>%
  group_by(m, alpha, method) %>%
  count(n_key_topics) %>%
  mutate(method = gsub("topics-", "", method))
```

```{r, fig.width = "8in", fig.height = "4in"}
ggplot(key_counts %>% filter(m != "K10", alpha %in% subset_alpha)) +
  geom_hline(yintercept = 5) +
  geom_point(aes(m, n_key_topics, col = alpha, size = n)) +
  scico::scale_color_scico(palette = "vikO", breaks = c(0, 0.5, 1)) +
  scale_size(range = c(0, 3)) +
  labs(x = "K Topics", y = "Key Topics", col = expression(alpha)) +
  facet_grid(method ~ alpha) +
  theme(axis.text.x = element_text(size = 7))
ggsave("~/Downloads/gradient_key_topics.png", dpi = 500)
```


```{r, fig.height = "3.5in", fig.width = "8in"}
ggplot(measures %>% filter(m != "K10", alpha %in% subset_alpha)) +
  geom_violin(
    aes(m, refinement, fill = alpha),
    bw = 0.05, size = 0
  ) +
  facet_grid(method ~ alpha) +
  scico::scale_fill_scico(palette = "vikO", breaks = c(0, 0.5, 1)) +
  labs(y = "Refinement", x = "K Topics", fill = expression(alpha)) +
  scale_y_log10() +
  theme(axis.text.x = element_text(size = 6))
ggsave("~/Downloads/gradient_refinement_full.png", dpi = 500)
```

```{r, fig.height = 3, fig.width = 5}
paths <- c("exper-transport_0_3_250_1000_5.rda", "exper-transport_0.4_1_250_1000_5.rda", "exper-transport_0.6_10_250_1000_5.rda", "exper-transport_1_1_250_1000_5.rda")
for (s in seq_along(paths)) {
  fit <- get(load(file.path(gradient_dir, paths[s])))[[2]]
  plot(fit)
  ggsave(sprintf("~/Downloads/gradient_flow-%s.png", s), dpi = 500, height = 3, width = 5)
}
```

### Functional Equivalence

```{r}
equiv_dir <- file.path(params$results, "equivalence")
similarities <- read_and_process("*similarities*", c("rep", "S"), equiv_dir)
```

```{r, fig.width = "1in", fig.height = "5in"}
exper <- get(load(file.path(equiv_dir, "exper-transport_230_12_250_1000_5.rda")))
sim_data <- exper[[1]]
fit <- exper[[2]]
plot(fit) +
  labs(x = "K Topics") +
  theme(axis.text.y = element_blank())
ggsave("~/Downloads/equivalence_flow.png", dpi = 750)
```

```{r, fig.height = 2, fig.width = 6}
plot_beta(fit, models = c("K5", "K6", "K7"), n_features = 200) +
  theme(
    axis.text = element_text(size = 10),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    panel.grid.major.y = element_blank(),
    strip.text = element_text(size = 12)
  ) +
  scale_size(range = c(0, 35), limits = c(0, 1))
ggsave("~/Downloads/equivalence_betas.png", dpi=750)
```

```{r, fig.height = "3in", fig.width = "4in"}
model_sims <- similarities %>%
  filter(
    file == "similarities-transport_230_12_250_1000_5.csv",
    m %in% str_c("K", 5:7)
  ) %>%
  group_by(m) %>%
  mutate(
    k_LDA = as.factor(row_number()),
  ) %>%
  pivot_longer(starts_with("V"), names_to = "truth", values_to = "similarity") %>%
  mutate(truth = gsub("V", "", truth))

ggplot(model_sims) +
  geom_tile(aes(k_LDA, truth, fill = similarity)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  facet_grid(~ m, scale = "free_x", space = "free") +
  labs(x = "Fitted Topic", y = "True Topic") +
  scico::scale_fill_scico(palette = "nuuk")
ggsave("~/Downloads/equivalence_similarity_hm.png", dpi=500, width = unit(7, "in"), height = unit(4, "in"))
```

```{r, fig.width = "10in", fig.height = "4in"}
diffs <- similarities %>%
  separate(file, c("method", "S", "id", "N", "V", "K"), "_", remove = FALSE) %>%
  mutate(
    method = gsub("similarities-", "", method),
    D1 = V1 - V2, D2 = V3 - V4,
    S = as.integer(S)
  ) %>%
  group_by(m, method, S, id, rep) %>%
  summarise(DTotal = mean(abs(V1 - V2) + abs(V3 - V4)))

ggplot(diffs, aes(S, DTotal)) +
  geom_smooth(method = "lm", col = "#5d3954") +
  geom_point(alpha = 0.6, size = 0.3) +
  facet_grid(method ~ m) +
  labs(x = "Perturbation Subset Size", y = "Estimation Sensitivity") +
  theme(axis.text.x = element_text(size = 6))
ggsave("~/Downloads/equivalence_similarities.png", dpi = 500)
```
