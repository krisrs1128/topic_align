---
title: "Simulations"
output:
  pdf_document:
    template: notes/style.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = FALSE, message = FALSE, warning = FALSE, fig.width = 5, fig.height = 2)
```

```{r}
library("MASS")
library("MCMCpack")
library("dplyr")
library("ggplot2")
library("ggraph")
library("magrittr")
library("pdist")
library("purrr")
library("stringr")
library("superheat")
library("tibble")
library("tidygraph")
library("tidyr")
library("tidytext")
library("topicmodels")
source("R_LSY/align_topics_all_functions.R")
source("simulation_functions.R")
set.seed(1234)
(theme_minimal() + 
  theme(
    panel.grid.minor = element_blank(),
    panel.background = element_rect(fill = "#f7f7f7"),
    panel.border = element_rect(fill = NA, color = "#0c0c0c", size = 0.6),
    legend.position = "bottom"
  )) %>%
  theme_set()
```

```{r}
N <- 100
V <- 250
K <- 4
sim_data <- equivalence_data(N, V, K, list(beta = .5, gamma = 0.1), subset_size = 75)
alignment <- vis_wrapper(sim_data$x, ceiling(1.5 * K))
```

```{r, fig.height = 2, fig.width = 7}
superheat(map(sim_data$B_tilde, ~ as_tibble(.)) %>% bind_rows(), legend = FALSE)
```

```{r, fig.height = 3, fig.width = 6}
alignment$p2
```

Compare the true with the estimated betas, before any perturbation.
```{r}
ordered_topics <- alignment$alignment$beta_alignment %>%
  select(m, k_LDA, topic) %>%
  unique()

alignment$fits$betas <- alignment$fits$betas %>%
  left_join(ordered_topics) %>%
  select(m, K, k_LDA, topic, w, b)
```

```{r, fig.width = 2, fig.height = 8}
beta_hats <- alignment$fits$betas %>%
  pivot_wider(m:topic, names_from = w, values_from = b)
beta_hats_mat <- beta_hats %>%
  select(matches("[0-9]+")) %>%
  as.matrix()
```

Now include the perturbed betas in the plot, and compare with estimates at a
more refined $K$.

```{r, fig.width = 2, fig.height = 8}
similarity <- cosine_similarity(beta_hats_mat, do.call(rbind, sim_data$B_tilde)) %>%
  as_tibble() %>%
  bind_cols(beta_hats %>% select(K, topic)) %>%
  pivot_longer(starts_with("V"), names_to = "beta", values_to = "sim") %>%
  mutate(
    beta = str_replace(beta, "V", ""),
    beta = str_pad(beta, 2)
  ) %>%
  filter(K < max(K))

ggplot(similarity, aes(beta, topic)) +
  geom_tile(aes(fill = sqrt(sim))) +
  scale_fill_distiller(direction = 1) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  facet_grid(K ~ ., scale = "free_y", space = "free")
```
